<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PLM Lite</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>

<div id="app-shell">

  <!-- ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <aside id="sidebar">
    <div id="sidebar-logo">PLM Lite <span>v1.0</span></div>

    <ul id="nav-list">
      <li><a href="#" data-panel="parts" class="nav-link active">
        <span class="nav-icon">üì¶</span> Parts
      </a></li>
      <li><a href="#" data-panel="bom" class="nav-link">
        <span class="nav-icon">üå≥</span> BOM / Tree
      </a></li>
      <li><a href="#" data-panel="documents" class="nav-link">
        <span class="nav-icon">üìÅ</span> Documents
      </a></li>
      <li id="admin-nav-item" style="display:none"><a href="#" data-panel="admin" class="nav-link">
        <span class="nav-icon">‚öôÔ∏è</span> Admin
      </a></li>
    </ul>

    <div id="user-chip">
      <div class="avatar" id="user-avatar">?</div>
      <div class="user-info">
        <div class="user-name" id="user-name">‚Ä¶</div>
        <div class="user-role" id="user-role">‚Ä¶</div>
      </div>
      <button class="logout-btn" onclick="logout()" title="Sign out">‚èª</button>
    </div>
  </aside>

  <!-- ‚îÄ‚îÄ Main content ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div id="main-content">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- PARTS PANEL                                                        -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="panel-parts" class="tab-panel active">
      <!-- Toolbar -->
      <div class="toolbar">
        <div class="search-box">
          <input id="parts-search" type="text" placeholder="Search part number or name‚Ä¶">
        </div>
        <select id="parts-status-filter">
          <option value="">All Statuses</option>
          <option value="Prototype">Prototype</option>
          <option value="Released">Released</option>
        </select>
        <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer">
          <input type="checkbox" id="parts-checkout-filter"> Checked out only
        </label>
        <div style="flex:1"></div>
        <button id="btn-new-part" class="btn btn-primary" id="can_write">+ New Part</button>
      </div>

      <!-- Split: list + detail -->
      <div class="split-view">
        <!-- List -->
        <div class="split-list">
          <div style="flex:1;overflow-y:auto">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Part #</th>
                  <th>Name</th>
                  <th>Rev</th>
                  <th>Status</th>
                  <th>Checkout</th>
                  <th>Updated</th>
                </tr>
              </thead>
              <tbody id="parts-tbody">
                <tr class="loading-row"><td colspan="6"><div class="spinner"></div></td></tr>
              </tbody>
            </table>
          </div>
          <div id="parts-pagination"></div>
        </div>

        <!-- Detail -->
        <div class="split-detail" id="parts-detail-empty">
          <div class="empty-hint">Select a part to view details</div>
        </div>
        <div class="split-detail" id="parts-detail" style="display:none">
          <div class="detail-header">
            <div style="display:flex;align-items:center;gap:10px">
              <span class="detail-pn" id="detail-pn"></span>
              <span id="detail-rev-chip"></span>
              <span id="detail-status-chip"></span>
              <span id="detail-checkout-chip"></span>
            </div>
          </div>
          <div class="detail-actions" id="detail-actions"></div>
          <div class="inner-tabs">
            <div class="inner-tab active" data-inner="details">Details</div>
            <div class="inner-tab" data-inner="attrs">Attributes</div>
            <div class="inner-tab" data-inner="revisions">Revisions</div>
            <div class="inner-tab" data-inner="docs">Documents</div>
          </div>
          <div style="flex:1;overflow-y:auto">
            <div class="inner-tab-panel active" id="detail-tab-details"></div>
            <div class="inner-tab-panel" id="detail-tab-attrs"></div>
            <div class="inner-tab-panel" id="detail-tab-revisions"></div>
            <div class="inner-tab-panel" id="detail-tab-docs"></div>
          </div>
        </div>
      </div>
    </div><!-- /panel-parts -->

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- BOM / TREE PANEL                                                   -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="panel-bom" class="tab-panel">
      <div class="toolbar">
        <div class="search-box" style="max-width:300px">
          <input id="bom-part-search" type="text" placeholder="Type part number‚Ä¶">
        </div>
        <div style="flex:1"></div>
        <button id="btn-where-used" class="btn btn-secondary">üîç Where Used</button>
        <button id="btn-export-bom" class="btn btn-secondary">üìä Export BOM</button>
        <button id="btn-add-rel" class="btn btn-primary">+ Add Relationship</button>
      </div>
      <div style="padding:16px 20px;flex-shrink:0">
        <span id="bom-selected-pn" style="font-size:16px;font-weight:600;color:var(--text)"></span>
      </div>
      <div id="bom-tree-container" style="flex:1;overflow-y:auto;padding:0 20px 20px">
        <p class="empty-hint">Type a part number above to view its BOM tree</p>
      </div>
    </div><!-- /panel-bom -->

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- DOCUMENTS PANEL                                                    -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="panel-documents" class="tab-panel">
      <div class="toolbar">
        <div class="search-box">
          <input id="docs-search" type="text" placeholder="Search documents‚Ä¶">
        </div>
        <div style="flex:1"></div>
        <label id="btn-upload-doc" class="btn btn-primary" style="cursor:pointer;display:none">
          ‚¨Ü Upload File
          <input type="file" id="doc-file-input" style="display:none">
        </label>
      </div>
      <div id="docs-list" style="flex:1;overflow-y:auto;padding:16px 20px">
        <div class="spinner"></div>
      </div>
    </div><!-- /panel-documents -->

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- ADMIN PANEL                                                        -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="panel-admin" class="tab-panel">
      <div class="toolbar">
        <div id="admin-tabs" style="display:flex;gap:4px">
          <div class="inner-tab active" data-tab="users">Users</div>
          <div class="inner-tab" data-tab="roles">Roles</div>
          <div class="inner-tab" data-tab="audit">Audit Log</div>
        </div>
        <div style="flex:1"></div>
        <button id="btn-create-user" class="btn btn-primary">+ New User</button>
        <button id="btn-create-role" class="btn btn-secondary">+ New Role</button>
      </div>

      <!-- Users tab -->
      <div id="admin-panel-users" class="admin-tab-panel active" style="flex:1;overflow-y:auto;padding:0 0 20px">
        <table class="data-table">
          <thead><tr><th>Username</th><th>Email</th><th>Role</th><th>Active</th><th>Actions</th></tr></thead>
          <tbody id="users-tbody"><tr class="loading-row"><td colspan="5"><div class="spinner"></div></td></tr></tbody>
        </table>
      </div>

      <!-- Roles tab -->
      <div id="admin-panel-roles" class="admin-tab-panel" style="flex:1;overflow-y:auto;padding:0 0 20px;display:none">
        <div id="roles-container"><div class="spinner" style="margin:40px auto;display:block"></div></div>
      </div>

      <!-- Audit tab -->
      <div id="admin-panel-audit" class="admin-tab-panel" style="flex:1;overflow-y:auto;padding:0 0 20px;display:none">
        <table class="data-table">
          <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Entity</th><th>Detail</th></tr></thead>
          <tbody id="audit-tbody"><tr class="loading-row"><td colspan="5"><div class="spinner"></div></td></tr></tbody>
        </table>
      </div>
    </div><!-- /panel-admin -->

  </div><!-- /main-content -->
</div><!-- /app-shell -->

<!-- Toast container -->
<div id="toast-container"></div>

<!-- ‚îÄ‚îÄ Scripts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<script src="/static/js/api.js"></script>
<script src="/static/js/utils.js"></script>
<script src="/static/js/parts.js"></script>
<script src="/static/js/relationships.js"></script>
<script src="/static/js/documents.js"></script>
<script src="/static/js/admin.js"></script>

<script>
  let currentUser = null;

  // ‚îÄ‚îÄ Admin tab panel show/hide ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.querySelectorAll('.admin-tab-panel').forEach(p => {
    p.style.display = p.classList.contains('active') ? '' : 'none';
  });
  document.getElementById('admin-tabs').addEventListener('click', e => {
    const tab = e.target.closest('[data-tab]');
    if (!tab) return;
    document.querySelectorAll('.admin-tab-panel').forEach(p => { p.style.display = 'none'; p.classList.remove('active'); });
    const panel = document.getElementById(`admin-panel-${tab.dataset.tab}`);
    if (panel) { panel.style.display = ''; panel.classList.add('active'); }
  });

  // ‚îÄ‚îÄ Nav switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      const panel = link.dataset.panel;
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      link.classList.add('active');
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.getElementById(`panel-${panel}`).classList.add('active');
    });
  });

  // ‚îÄ‚îÄ Inner tab switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.querySelectorAll('.inner-tabs').forEach(tabs => {
    tabs.addEventListener('click', e => {
      const tab = e.target.closest('.inner-tab');
      if (!tab) return;
      const key = tab.dataset.inner;
      tabs.querySelectorAll('.inner-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      document.querySelectorAll(`.inner-tab-panel`).forEach(p => p.classList.remove('active'));
      document.getElementById(`detail-tab-${key}`).classList.add('active');
    });
  });

  // ‚îÄ‚îÄ Logout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function logout() {
    await fetch('/auth/logout', { method: 'POST', credentials: 'same-origin' });
    window.location.href = '/login';
  }

  // ‚îÄ‚îÄ Bootstrap ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  (async () => {
    try {
      currentUser = await api.get('/auth/me');
    } catch (_) {
      window.location.href = '/login';
      return;
    }

    // Update user chip
    document.getElementById('user-name').textContent = currentUser.username;
    document.getElementById('user-role').textContent = currentUser.role_name || 'User';
    document.getElementById('user-avatar').textContent = currentUser.username[0].toUpperCase();

    // Show admin nav if applicable
    if (currentUser.can_admin) {
      document.getElementById('admin-nav-item').style.display = '';
    }

    // Force password change
    if (currentUser.must_change_password) {
      createModal('modal-change-pw', 'Change Password Required', `
        <p style="color:var(--muted);font-size:13px;margin-bottom:8px">You must set a new password before continuing.</p>
        <div class="form-group"><label>New Password</label><input type="password" id="new-pw" placeholder="Min 6 characters"></div>
        <div class="form-group"><label>Confirm Password</label><input type="password" id="new-pw2"></div>
      `, async () => {
        const pw = document.getElementById('new-pw').value;
        const pw2 = document.getElementById('new-pw2').value;
        if (pw !== pw2) return showToast('Passwords do not match', 'error');
        if (pw.length < 6) return showToast('Min 6 characters', 'error');
        try {
          await api.post('/auth/change-password', { new_password: pw });
          closeModal('modal-change-pw');
          showToast('Password changed', 'success');
        } catch (e) { showToast(e.message, 'error'); }
      }, 'Save Password');
    }

    // Init all panels
    await PartsPanel.init(currentUser);
    await RelPanel.init(currentUser);
    await DocsPanel.init(currentUser);
    if (currentUser.can_admin) await AdminPanel.init(currentUser);
  })();
</script>
</body>
</html>

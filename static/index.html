<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PLM Lite — Login</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <style>
    body { background: linear-gradient(135deg, #f8f9fa 0%, #e8f0fe 100%); }
  </style>
</head>
<body>
<div class="login-page">
  <div class="login-card">
    <div class="login-logo">PLM Lite</div>
    <div class="login-sub">Product Lifecycle Management</div>

    <!-- Google OAuth button — shown only when AUTH_MODE=google -->
    <div id="google-section" style="display:none">
      <a href="/auth/google" class="google-btn">
        <svg width="18" height="18" viewBox="0 0 18 18">
          <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
          <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2.02c-.72.48-1.63.76-2.7.76-2.07 0-3.82-1.4-4.45-3.28H1.87v2.07A8 8 0 0 0 8.98 17z"/>
          <path fill="#FBBC05" d="M4.53 10.52A4.8 4.8 0 0 1 4.28 9c0-.53.09-1.04.25-1.52V5.41H1.87A8 8 0 0 0 .98 9c0 1.29.31 2.51.89 3.59l2.66-2.07z"/>
          <path fill="#EA4335" d="M8.98 3.58c1.16 0 2.2.4 3.02 1.19l2.26-2.26A8 8 0 0 0 1.87 5.41L4.53 7.48C5.16 5.6 6.91 3.58 8.98 3.58z"/>
        </svg>
        Sign in with Google
      </a>
    </div>

    <!-- Local login form — shown only when AUTH_MODE=local -->
    <div id="local-section" style="display:none">
      <form class="login-form" id="login-form" onsubmit="submitLogin(event)">
        <div>
          <label for="username">Username</label>
          <input type="text" id="username" name="username" autocomplete="username" required autofocus>
        </div>
        <div>
          <label for="password">Password</label>
          <input type="password" id="password" name="password" autocomplete="current-password" required>
        </div>
        <div id="login-error" class="login-error"></div>
        <button type="submit" class="btn btn-primary" id="login-btn" style="width:100%;justify-content:center">
          Sign In
        </button>
      </form>
    </div>

    <!-- Fallback: loading -->
    <div id="loading-section">
      <div style="text-align:center;padding:20px"><div class="spinner" style="margin:0 auto"></div></div>
    </div>
  </div>
</div>

<script>
  (async () => {
    try {
      const resp = await fetch('/auth/me', { credentials: 'same-origin' });
      if (resp.ok) { window.location.href = '/app'; return; }
    } catch (_) {}

    const modeResp = await fetch('/auth/me', { credentials: 'same-origin' }).catch(() => null);
    // Check auth_mode from a meta endpoint
    const infoResp = await fetch('/auth/me', { credentials: 'same-origin' }).catch(() => null);

    // Read auth_mode from backend via a dedicated endpoint
    const modeData = await fetch('/api/auth-mode').then(r => r.json()).catch(() => ({ mode: 'local' }));

    document.getElementById('loading-section').style.display = 'none';
    if (modeData.mode === 'google') {
      document.getElementById('google-section').style.display = '';
    } else {
      document.getElementById('local-section').style.display = '';
    }
  })();

  async function submitLogin(e) {
    e.preventDefault();
    const btn = document.getElementById('login-btn');
    const err = document.getElementById('login-error');
    err.classList.remove('visible');
    btn.disabled = true;
    btn.textContent = 'Signing in…';

    try {
      const resp = await fetch('/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({
          username: document.getElementById('username').value,
          password: document.getElementById('password').value,
        }),
      });

      if (resp.ok) {
        window.location.href = '/app';
      } else {
        const data = await resp.json().catch(() => ({}));
        err.textContent = data.detail || 'Invalid username or password';
        err.classList.add('visible');
        btn.disabled = false;
        btn.textContent = 'Sign In';
      }
    } catch (_) {
      err.textContent = 'Network error — please try again';
      err.classList.add('visible');
      btn.disabled = false;
      btn.textContent = 'Sign In';
    }
  }
</script>
</body>
</html>
